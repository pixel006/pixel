<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>История депозитов и начислений</title>
<style>
body {
  margin: 0;
  font-family: "Inter", "Segoe UI", Roboto, sans-serif;
  background: #101222;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
  padding: 20px 0;
}
.container {
  background: rgba(20,20,40,0.95);
  padding: 30px 20px;
  border-radius: 16px;
  box-shadow: 0 0 32px rgba(0,224,255,0.4);
  width: 90%;
  max-width: 400px;
  text-align: left;
  position: relative;
}
h1, h2 {
  text-align: center;
  color: #00e0ff;
  margin-bottom: 16px;
}
.deposit-card {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(0,224,255,0.2);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 0.9em;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid rgba(0,224,255,0.2);
  text-align: left;
}
th {
  color: #00e0ff;
}
tr:hover {
  background: rgba(0,224,255,0.1);
  transition: 0.2s;
}
p.no-transactions {
  text-align: center;
  font-size: 0.95em;
  color: rgba(255,255,255,0.7);
  margin-top: 10px;
}
nav.fixed-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #101222;
  padding: 10px 0;
  text-align: center;
  box-shadow: 0 -2px 8px rgba(0,224,255,0.3);
}
nav.fixed-footer a {
  display: inline-block;
  width: 40%;
  max-width: 150px;
  margin: 0 5px;
  padding: 10px 0;
  background: linear-gradient(135deg, #00e0ff, #6a5acd);
  color: white;
  text-decoration: none;
  border-radius: 12px;
  font-weight: 600;
  transition: 0.3s;
}
nav.fixed-footer a:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(0,224,255,0.5);
}
#notification {
  position: absolute;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  padding: 12px 20px;
  border-radius: 12px;
  font-weight: 600;
  display: none;
  color: #fff;
  box-shadow: 0 0 20px rgba(0,224,255,0.5);
}
#notification.success {
  background: linear-gradient(135deg, #00e0ff, #6a5acd);
}
#notification.error {
  background: linear-gradient(135deg, #ff4c4c, #ff0000);
}
</style>
</head>
<body>
<div class="container">
  <div id="notification"></div>
  <h1>История депозитов и начислений</h1>

  <!-- Депозиты -->
  <% if (deposits && deposits.length > 0) { %>
    <% deposits.forEach(dep => { %>
      <div class="deposit-card">
        <% if(dep.status === 'active') { %>
          <strong>В работе :</strong> <%= dep.principal.toFixed(2) %>$<br>
          <strong>Дней до завершения:</strong> <%= dep.remainingDays %> / 30<br>
          <strong>Начислено процентов:</strong> <%= dep.accrued.toFixed(2) %>$<br>
          <strong>Последнее начисление:</strong> <%= dep.lastInterestDate ? new Date(dep.lastInterestDate).toLocaleString() : '—' %>
        <% } else { %>
          <strong>Завершён :</strong> <%= dep.principal.toFixed(2) %>$<br>
          <strong>Депозит завершён после 30 дней</strong><br>
          <strong>Всего начислено:</strong> <%= dep.accrued.toFixed(2) %>$<br>
          <strong>Завершено:</strong> <%= dep.createdAt ? new Date(dep.createdAt.getTime() + 30*24*60*60*1000).toLocaleString() : '—' %>
        <% } %>
      </div>
    <% }) %>
  <% } else { %>
    <p class="no-transactions">Депозиты пока отсутствуют.</p>
  <% } %>

  <!-- Проценты от приглашённых -->
  <h2>Проценты от приглашённых</h2>
  <% const referralTx = transactions ? transactions.filter(tx => tx.type === 'referral_bonus') : []; %>
  <% if (referralTx.length === 0) { %>
    <p class="no-transactions">Бонусов от приглашённых пока нет.</p>
  <% } else { %>
    <% const sortedReferrals = referralTx.sort((a, b) => new Date(b.date) - new Date(a.date)); %>
    <table>
      <thead>
        <tr>
          <th>Приглашённый</th>
          <th>Бонус ($)</th>
          <th>Дата</th>
          <th>Описание</th>
        </tr>
      </thead>
      <tbody>
        <% sortedReferrals.forEach(tx => { %>
          <tr>
            <td>
              <% 
                let inviterName = "—"; 
                if(tx.fromUserName) inviterName = tx.fromUserName;
                else if(tx.description) {
                    const match = tx.description.match(/реферала (\w+)/);
                    if(match) inviterName = match[1];
                }
              %>
              <%= inviterName %>
            </td>
            <td><%= tx.amount.toFixed(2) %></td>
            <td><%= tx.date ? new Date(tx.date).toLocaleString() : '—' %></td>
            <td>Бонус <%= tx.percent || '' %>% от депозита реферала</td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<nav class="fixed-footer">
  <a href="/">Главная</a>
  <a href="/group">Моя группа</a>
</nav>

<script>
const notification = document.getElementById('notification');
function showNotification(message, type="success") {
  notification.textContent = message;
  notification.className = '';
  notification.classList.add(type);
  notification.style.display = 'block';
  setTimeout(() => notification.style.display = 'none', 3000);
}
</script>
</body>
</html>
