<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Редактор страницы <%= page.name %></title>

<link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet"/>
<link href="https://unpkg.com/grapesjs-preset-webpage/dist/grapesjs-preset-webpage.min.css" rel="stylesheet"/>

<style>
  body, html { margin:0; height:100%; }
  #gjs { height:100vh; }
  .save-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 9999;
    padding: 8px 12px;
    background: #5c6bc0;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="gjs"><%= page.html %></div>

<script src="https://unpkg.com/grapesjs"></script>
<script src="https://unpkg.com/grapesjs-preset-webpage"></script>
<script src="https://unpkg.com/grapesjs-plugin-code-editor"></script>
<script src="https://unpkg.com/grapesjs-plugin-export"></script>

<script>
const editor = grapesjs.init({
  container: '#gjs',
  fromElement: true,
  height: '100%',
  width: 'auto',
  storageManager: { type: 'none' },
  plugins: ['gjs-preset-webpage','gjs-plugin-code-editor','gjs-plugin-export'],
  pluginsOpts: {
    'gjs-preset-webpage': {},
    'gjs-plugin-code-editor': {},
    'gjs-plugin-export': {}
  }
});

// Кнопка сохранения страницы
const saveBtn = document.createElement('button');
saveBtn.textContent = 'Сохранить страницу';
saveBtn.className = 'save-btn';
saveBtn.onclick = async () => {
  const html = editor.getHtml();
  const css = editor.getCss();
  const js = editor.getJs();

  const res = await fetch('/grapes/<%= page.name %>/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ html, css, js })
  });

  const data = await res.json();
  alert(data.message);
};
document.body.appendChild(saveBtn);

// Пример динамического блока с балансом пользователя
editor.BlockManager.add('balance', {
  label: 'Баланс пользователя',
  category: 'Динамика',
  content: `<p>Баланс: $<%= currentUser.balance.toFixed(2) %></p>`
});

// Можно добавить другие динамические блоки или свои HTML элементы
editor.BlockManager.add('button', {
  label: 'Кнопка',
  category: 'Элементы',
  content: '<button>Новая кнопка</button>'
});
</script>
</body>
</html>