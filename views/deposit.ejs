<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–µ–ø–æ–∑–∏—Ç</title>
<style>
body {
  margin: 0;
  font-family: "Inter", "Segoe UI", Roboto, sans-serif;
  background: #101222;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  overflow-x: hidden;
  position: relative;
}
.container {
  background: rgba(20, 20, 40, 0.95);
  padding: 40px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 0 32px rgba(0,224,255,0.4);
  width: 340px;
  position: relative;
}
input[type=number] {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  margin-bottom: 16px;
  font-size: 1em;
  background: rgba(0,0,0,0.3);
  color: #fff;
}
button {
  padding: 12px 24px;
  font-size: 1em;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #00e0ff, #6a5acd);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0,224,255,0.4);
  transition: 0.3s;
}
button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px rgba(0,224,255,0.6);
}
#notification {
  position: absolute;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  padding: 12px 20px;
  border-radius: 12px;
  font-weight: 600;
  display: none;
  color: #fff;
  box-shadow: 0 0 20px rgba(0,224,255,0.5);
  transition: opacity 0.3s ease;
  opacity: 0;
}
#notification.success { background: linear-gradient(135deg, #00e0ff, #6a5acd); }
#notification.error { background: linear-gradient(135deg, #ff4c4c, #ff0000); }
#notification.show { display: block; opacity: 1; }
.coin {
  position: absolute;
  font-size: 22px;
  color: #00e0ff;
  user-select: none;
  pointer-events: none;
  z-index: 1;
}
</style>
</head>
<body>

<div class="container">
  <div id="notification"></div>
  <h2>–í–∞—à –±–∞–ª–∞–Ω—Å: $<%= currentUser.balance.toFixed(2) %></h2>

  <!-- –ö–Ω–æ–ø–∫–∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å -->
  <button id="topupBtn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>

  <hr style="margin:20px 0; border-color: rgba(255,255,255,0.2)">

  <!-- –í–≤–æ–¥ —Å—É–º–º—ã –¥–µ–ø–æ–∑–∏—Ç–∞ -->
  <input type="number" id="depositAmount" placeholder="–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞" min="50" max="<%= currentUser.balance.toFixed(2) %>">
  <button id="depositBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç</button>
</div>

<script>
const depositBtn = document.getElementById('depositBtn');
const depositInput = document.getElementById('depositAmount');
const notification = document.getElementById('notification');
let userBalance = Number(`<%= currentUser.balance.toFixed(2) %>`);

function showNotification(message, type = "success") {
  notification.textContent = message;
  notification.className = '';
  notification.classList.add(type, 'show');
  setTimeout(() => notification.classList.remove('show'), 3000);
}

// –ó–∞–ø—É—Å–∫ –¥–µ–ø–æ–∑–∏—Ç–∞
depositBtn.addEventListener('click', async () => {
  const amount = parseFloat(depositInput.value);
  if (!amount || amount <= 0) return showNotification("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞", "error");
  if (amount < 50) return showNotification("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ ‚Äî 50$", "error");
  if (amount > userBalance) return showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", "error");

  depositBtn.disabled = true;
  depositBtn.textContent = '...';

  try {
    const res = await fetch('/start-deposit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount })
    });

    if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${res.status}`);
    const data = await res.json();

    if (data.success) {
      let msg = `–î–µ–ø–æ–∑–∏—Ç $${amount} –∑–∞–ø—É—â–µ–Ω! –ù–∞—á–∏—Å–ª–µ–Ω–æ ${data.newBalance - (userBalance - amount)}$`;
      if (data.referralBonus) msg += `. –†–µ—Ñ–µ—Ä–∞–ª –ø–æ–ª—É—á–∏–ª –±–æ–Ω—É—Å ${data.referralBonus.toFixed(2)}$`;
      showNotification(msg, "success");
      depositInput.value = '';
      userBalance = data.newBalance;
    } else {
      showNotification(data.message || "–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏", "error");
    }
  } catch (err) {
    console.error(err);
    showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', "error");
  } finally {
    depositBtn.disabled = false;
    depositBtn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç';
  }
});

// –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
document.getElementById('topupBtn').addEventListener('click', () => {
  window.open('/deposit/topup', '_blank', 'width=400,height=500,scrollbars=yes');
});

// –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–Ω–µ—Ç
const layers = [
  { speed: 4, size: [18,24], opacity: [0.4,0.7], sway: 15 },
  { speed: 6, size: [14,20], opacity: [0.3,0.6], sway: 10 },
  { speed: 8, size: [10,16], opacity: [0.2,0.5], sway: 6 }
];

function spawnCoin() {
  const layer = layers[Math.floor(Math.random()*layers.length)];
  const coin = document.createElement("div");
  coin.classList.add("coin");
  coin.textContent = "üí∞";
  coin.style.left = Math.random()*100 + "vw";
  coin.style.top = Math.random()*100 + "vh";
  coin.style.fontSize = (Math.random()*(layer.size[1]-layer.size[0]) + layer.size[0]) + "px";
  coin.style.opacity = Math.random()*(layer.opacity[1]-layer.opacity[0]) + layer.opacity[0];
  const startRotation = Math.random()*360;
  let rotationSpeed = (Math.random()*30 + 15) * (Math.random() < 0.5 ? -1 : 1);
  let start = Date.now();

  function animateCoin() {
    const elapsed = (Date.now() - start)/1000;
    const offsetX = Math.sin(elapsed * 2 * Math.PI / layer.speed) * layer.sway;
    const rotation = startRotation + elapsed * rotationSpeed;
    coin.style.transform = `translateX(${offsetX}px) rotate(${rotation}deg)`;
    requestAnimationFrame(animateCoin);
  }
  animateCoin();
  document.body.appendChild(coin);
  setTimeout(() => coin.remove(), layer.speed*1000 + 1000);
}
setInterval(spawnCoin, 400);
</script>

</body>
</html>
